<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Graphrel—relation-based WYSIWYG graph editor</title>
    <link rel="stylesheet" type="text/css" href="http://w2ui.com/src/w2ui-1.4.2.min.css" />
    <link rel="stylesheet" type="text/css" href="main.css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script src="http://w2ui.com/src/w2ui-1.4.2.min.js"></script>
    <script src="//cdn.jsdelivr.net/filesaver.js/0.1/FileSaver.min.js"></script>
    <script>
        if (!window.jQuery) { document.write('<script src="lib/jquery.min.js"><\/script>'); }
        if (!window.w2ui) { document.write('<script src="lib/w2ui-1.4.2.min.js"><\/script>'); }
        if (!window.saveAs) { document.write('<script src="lib/FileSaver.min.js"><\/script>'); }
    </script>

</head>
<body>

    <div id="header">
        <h2>Graphrel</h2>
        <h3>Create Your Graph</h3>
    </div>

    <div id="control_buttons" style="position:relative; left:2px">
        <input type="image" id="howto" title="how to" src="img/howto.png" alt="how to" onclick="w2ui['layout'].toggle('top', window.instant)" />
        <input type="image" id="edit" title="edit" src="img/edit.png" alt="edit" onclick="w2ui['layout'].toggle('right', window.instant)" class="clicked" />
        <input type="image" id="startover" title="start over" src="img/startover.png" alt="edit" onclick="graphWin.clear()" />
        <input type="file" id="hidden-file-upload" style="display:none" onchange="handleFileUpload(this)" />
        <input type="image" id="upload" title="upload adjacency list" src="img/upload.png" alt="upload adjacency list" onclick="triggerUpload()" />
        <input type="image" id="save" title="save adjacency list" src="img/save.png" alt="save adjacency list" onclick="handleSave()" />
    </div>

    <div id="layout" style="position: absolute; top: 150px; bottom: 50px; left: 10px; right: 10px;"></div> <!--Use absolute positioning. This allows layout to be auto resized-->

    <div id="footer" style="position: absolute; bottom: 10px; left: 10px; right: 10px;"><a href="https://github.com/yiboyang/graphrel" target="_blank">View on GitHub</a></div>

    <script type="text/javascript">
        $(function () {
            var pstyle = 'border: 1px solid #dfdfdf; padding: 5px;';
            $('#layout').w2layout({
                name: 'layout',
                padding: 4,
                panels: [
                    { type: 'top', size: 75, style: pstyle, hidden: true, content: '<div id="instructions"><ul><li>Click in the open space to add a node, drag from one node to another to add an edge. <kbd>ctrl</kbd>+drag a node to position it. Click a node or an edge to select it.</li><li>When a node is selected: <kbd>delete</kbd> removes it, <kbd>R</kbd> toggles reflexivity (loop). When an edge is selected: <kbd>delete</kbd> removes it, <kbd>L</kbd>, <kbd>R</kbd>, <kbd>B</kbd> change direction.</li><li>Edit, save or upload your own adjacency list!</li></ul></div>' },
                    { type: 'main', minSize: 480, resizable: true, style: pstyle, content: "<div id='graphContainer' style='width: 100%; height: 100%;'><iframe id='graph' scrolling='no' sandbox='allow-scripts allow-forms allow-same-origin' marginwidth='0' marginheight='0' frameborder='0' src='graph.html'></iframe></div>" },
                    { type: 'right', minSize: 200, size: '30%', resizable: true, style: pstyle, content: "<div style='width: 100%; height: 100%'><iframe id='adjlist' sandbox='allow-scripts allow-forms allow-same-origin' marginwidth='0' xmarginheight='0' frameborder='0' src='adjlist.html'></iframe></div>" },
                ]
            });
        });

        $(document).ready(function () {
            $('#howto, #edit').click(function () {
                $(this).toggleClass("clicked");
            });
        });

        // this is needed before the graph iframe loads and renders using the x/ybounds
        $('graph').ready(function () {
            mainPanel = document.getElementById('layout_layout_panel_main');
            graphWin = document.getElementById('graph').contentWindow;
            // dynamically reset force layout bounds on resize event completion
            w2ui['layout'].on('resize', function (event) {
                event.onComplete = function () {
                    graphWin.xbound = parseInt(mainPanel.style.width, 10);
                    graphWin.ybound = parseInt(mainPanel.style.height, 10);
                    if (graphWin.force)
                        graphWin.force.start();
                }
            });
        })

        // initialize textarea window
        // the setTimeout hack makes sure necessary scripts are executed (IE only issue)
        window.onload = function () {
            adjWin = document.getElementById('adjlist').contentWindow;
            (function deferInit() {
                if (adjWin.init && graphWin.updateAdjlistFrame) {
                    adjWin.init();
                    graphWin.alBox = adjWin.document.getElementById('alBox');
                    graphWin.updateAdjlistFrame();
                }
                else
                    setTimeout(function () { deferInit() }, 50);
            })();
        }

        function handleFileUpload(fileElem) {
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                var fileUp = fileElem.files[0];
                if (!fileUp.type.match(/text.*/))
                    alert("Only text file supported; you may have to add the '.txt' extension");
                else if (fileUp.size > 1024)
                    alert("Sorry, your adjacency list is too large...");
                else {
                    var reader = new window.FileReader();
                    reader.onload = function () {
                        var result = adjWin.validate(reader.result);
                        if (result == -1 || result == 0)
                            alert("Couldn't parse your adjacency list--make sure its syntax looks something like 'nodeX:[nodeY,nodeZ],...");
                        else {
                            var obj;
                            if (result == 2)
                                obj = [];
                            else
                                obj = result;
                            this.className = "valid";
                            graphWin.createFromList(obj);
                            graphWin.updateAdjlistFrame();
                        }
                    }
                    reader.readAsText(fileUp);
                }
                fileElem.value = ''; // reset file input; otherwise nothing happens if user uploads the same file twice; may break in IE<11
            }
            else
                alert("Your browser doesn't support this--try upgrading to IE 10+/Chrome/Firefox");
        }

        function triggerUpload() {
            document.getElementById("hidden-file-upload").click();
        }

        function handleSave() {
            var blob = new Blob([JSON.stringify(graphWin.getAdjlist()).replace(/["'{}]/g, "")], { type: "text/plain" });
            saveAs(blob, "awesomeGraph.txt");
        }

    </script>

</body>
</html>